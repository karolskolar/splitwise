<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Splitwise - KalkulaÄka nÃ¡kladov</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ”ï¸</text></svg>">
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
const { useState, useEffect, useCallback, useRef } = React;

// Configuration
const API_URL = window.location.hostname === 'localhost'
  ? 'http://localhost:3001'
  : 'https://splitwise-api.skolar.sk';

// Google Client ID - UPDATE THIS with your Google Cloud Console OAuth Client ID
const GOOGLE_CLIENT_ID = '876217692318-3vdc3s8mr44l48fndia3ikjvvnnol8sd.apps.googleusercontent.com';

const generateId = () => Math.random().toString(36).substr(2, 9);

// Auth token management
const getAuthToken = () => localStorage.getItem('auth_token');
const setAuthToken = (token) => localStorage.setItem('auth_token', token);
const clearAuthToken = () => localStorage.removeItem('auth_token');

// API helpers with auth
const apiRequest = async (endpoint, options = {}) => {
  const token = getAuthToken();
  const headers = {
    'Content-Type': 'application/json',
    ...(token && { 'Authorization': `Bearer ${token}` }),
    ...options.headers
  };

  const response = await fetch(`${API_URL}${endpoint}`, {
    ...options,
    headers
  });

  if (response.status === 401) {
    clearAuthToken();
    window.location.reload();
    throw new Error('Unauthorized');
  }

  return response;
};

// URL encoding/decoding for shareable links (legacy support)
const encodeCalcData = (calc) => {
  try {
    const json = JSON.stringify(calc);
    const base64 = btoa(unescape(encodeURIComponent(json)));
    return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
  } catch (e) {
    console.error('Failed to encode:', e);
    return null;
  }
};

const decodeCalcData = (encoded) => {
  try {
    let base64 = encoded.replace(/-/g, '+').replace(/_/g, '/');
    while (base64.length % 4) base64 += '=';
    const json = decodeURIComponent(escape(atob(base64)));
    return JSON.parse(json);
  } catch (e) {
    console.error('Failed to decode:', e);
    return null;
  }
};

// API functions
const saveToApi = async (calculation) => {
  try {
    const response = await apiRequest('/api/save', {
      method: 'POST',
      body: JSON.stringify(calculation)
    });
    if (!response.ok) throw new Error('API error');
    const { id } = await response.json();
    return id;
  } catch (e) {
    console.error('Failed to save to API:', e);
    return null;
  }
};

const loadFromApi = async (id) => {
  try {
    const response = await fetch(`${API_URL}/api/load/${id}`);
    if (!response.ok) return null;
    return await response.json();
  } catch (e) {
    console.error('Failed to load from API:', e);
    return null;
  }
};

const loadUserCalculations = async () => {
  try {
    const response = await apiRequest('/api/calculations');
    if (!response.ok) return [];
    return await response.json();
  } catch (e) {
    console.error('Failed to load calculations:', e);
    return [];
  }
};

const deleteCalculation = async (id) => {
  try {
    const response = await apiRequest(`/api/calculations/${id}`, {
      method: 'DELETE'
    });
    return response.ok;
  } catch (e) {
    console.error('Failed to delete calculation:', e);
    return false;
  }
};

const updateCalculation = async (id, data) => {
  try {
    const response = await apiRequest(`/api/calculations/${id}`, {
      method: 'POST',
      body: JSON.stringify(data)
    });
    return response.ok;
  } catch (e) {
    console.error('Failed to update calculation:', e);
    return false;
  }
};

// Default factories
const defaultGroup = (type = 'group') => ({
  id: generateId(),
  name: '',
  type: type,
  members: [{ id: generateId(), name: '', isChild: false, coefficient: 1.0 }],
  nights: 1,
});

const defaultExpense = () => ({
  id: generateId(),
  familyId: '',
  category: 'food',
  description: '',
  amount: 0,
});

const defaultSettings = () => ({
  accommodation: 'perPerson',
  food: 'perPerson',
  other: 'perFamily',
});

const defaultCalculation = () => ({
  id: generateId(),
  name: 'NovÃ¡ dovolenka',
  createdAt: new Date().toISOString(),
  families: [defaultGroup(), defaultGroup()],
  expenses: [],
  settings: defaultSettings(),
  notes: '',
});

// Calculation logic
const getGroupLabel = (group) => {
  if (group.name) return group.name;
  return group.type === 'individual' ? 'Jednotlivec' : 'Skupina';
};

const calculateShares = (calculation) => {
  const { families, expenses, settings = defaultSettings() } = calculation;

  const familyMetrics = families.map(family => {
    const memberCount = family.members.length;
    const bedNights = memberCount * family.nights;
    const coefficientSum = family.members.reduce((sum, m) => sum + (m.coefficient || 1.0), 0);
    const weightedUnits = coefficientSum * family.nights;
    return { ...family, memberCount, bedNights, coefficientSum, weightedUnits };
  });

  const totalFamilies = families.length;
  const totalBedNights = familyMetrics.reduce((sum, f) => sum + f.bedNights, 0);
  const totalWeightedUnits = familyMetrics.reduce((sum, f) => sum + f.weightedUnits, 0);

  const expensesByCategory = {
    accommodation: expenses.filter(e => e.category === 'accommodation').reduce((sum, e) => sum + e.amount, 0),
    food: expenses.filter(e => e.category === 'food').reduce((sum, e) => sum + e.amount, 0),
    other: expenses.filter(e => e.category === 'other').reduce((sum, e) => sum + e.amount, 0),
  };

  const totalExpenses = expensesByCategory.accommodation + expensesByCategory.food + expensesByCategory.other;

  const paidByFamily = families.map(family => ({
    familyId: family.id,
    familyName: getGroupLabel(family),
    familyType: family.type,
    total: expenses.filter(e => e.familyId === family.id).reduce((sum, e) => sum + e.amount, 0),
  }));

  const getShare = (family, category, amount) => {
    const fm = familyMetrics.find(f => f.id === family.id);
    const setting = settings[category] || 'perPerson';

    if (setting === 'perFamily') {
      return totalFamilies > 0 ? amount / totalFamilies : 0;
    } else {
      return totalWeightedUnits > 0 ? (fm.weightedUnits / totalWeightedUnits) * amount : 0;
    }
  };

  const shouldPayByFamily = familyMetrics.map(family => {
    const accommodationShare = getShare(family, 'accommodation', expensesByCategory.accommodation);
    const foodShare = getShare(family, 'food', expensesByCategory.food);
    const otherShare = getShare(family, 'other', expensesByCategory.other);

    const familyPercent = totalFamilies > 0 ? (1 / totalFamilies) * 100 : 0;
    const weightedPercent = totalWeightedUnits > 0 ? (family.weightedUnits / totalWeightedUnits) * 100 : 0;

    return {
      familyId: family.id,
      familyName: getGroupLabel(family),
      familyType: family.type,
      accommodation: accommodationShare,
      food: foodShare,
      other: otherShare,
      total: accommodationShare + foodShare + otherShare,
      bedNights: family.bedNights,
      weightedUnits: family.weightedUnits,
      coefficientSum: family.coefficientSum,
      memberCount: family.memberCount,
      nights: family.nights,
      familyPercent,
      weightedPercent,
    };
  });

  const balances = families.map(family => {
    const paid = paidByFamily.find(p => p.familyId === family.id)?.total || 0;
    const shouldPay = shouldPayByFamily.find(s => s.familyId === family.id)?.total || 0;
    return {
      familyId: family.id,
      familyName: getGroupLabel(family),
      familyType: family.type,
      paid,
      shouldPay,
      balance: paid - shouldPay,
    };
  });

  const settlements = [];
  const tempBalances = balances.map(b => ({ ...b }));

  const creditors = tempBalances.filter(b => b.balance > 0.01).sort((a, b) => b.balance - a.balance);
  const debtors = tempBalances.filter(b => b.balance < -0.01).sort((a, b) => a.balance - b.balance);

  for (const debtor of debtors) {
    for (const creditor of creditors) {
      if (debtor.balance >= -0.01) break;
      if (creditor.balance <= 0.01) continue;

      const amount = Math.min(creditor.balance, -debtor.balance);
      if (amount > 0.01) {
        settlements.push({
          from: debtor.familyName,
          to: creditor.familyName,
          amount: Math.round(amount * 100) / 100,
        });
        debtor.balance += amount;
        creditor.balance -= amount;
      }
    }
  }

  return {
    expensesByCategory,
    totalExpenses,
    paidByFamily,
    shouldPayByFamily,
    balances,
    settlements,
    totalBedNights,
    totalWeightedUnits,
    settings,
  };
};

// Components
const SettingsPanel = ({ settings, onUpdate }) => {
  const categories = [
    { key: 'accommodation', label: 'ğŸ  Ubytovanie', icon: 'ğŸ ' },
    { key: 'food', label: 'ğŸ½ï¸ Strava', icon: 'ğŸ½ï¸' },
    { key: 'other', label: 'ğŸ“¦ InÃ©', icon: 'ğŸ“¦' },
  ];

  return (
    <div className="bg-white rounded-lg shadow p-4 mb-4">
      <h3 className="font-semibold text-gray-800 mb-3">âš™ï¸ Nastavenie spÃ´sobu vÃ½poÄtu</h3>
      <div className="space-y-3">
        {categories.map(cat => (
          <div key={cat.key} className="flex flex-col sm:flex-row sm:items-center gap-2">
            <span className="text-sm font-medium w-32">{cat.label}:</span>
            <div className="flex gap-2 flex-wrap">
              <label className="flex items-center gap-1 cursor-pointer">
                <input
                  type="radio"
                  name={`setting-${cat.key}`}
                  checked={settings[cat.key] === 'perFamily'}
                  onChange={() => onUpdate({ ...settings, [cat.key]: 'perFamily' })}
                  className="text-blue-600"
                />
                <span className="text-sm">RovnÃ½m dielom</span>
              </label>
              <label className="flex items-center gap-1 cursor-pointer">
                <input
                  type="radio"
                  name={`setting-${cat.key}`}
                  checked={settings[cat.key] === 'perPerson'}
                  onChange={() => onUpdate({ ...settings, [cat.key]: 'perPerson' })}
                  className="text-blue-600"
                />
                <span className="text-sm">PodÄ¾a osÃ´b</span>
              </label>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
};

const COEFFICIENT_OPTIONS = [
  { value: '0.1', label: '0.1Ã—' },
  { value: '0.2', label: '0.2Ã—' },
  { value: '0.3', label: '0.3Ã—' },
  { value: '0.4', label: '0.4Ã—' },
  { value: '0.5', label: '0.5Ã—' },
  { value: '0.6', label: '0.6Ã—' },
  { value: '0.7', label: '0.7Ã—' },
  { value: '0.8', label: '0.8Ã—' },
  { value: '0.9', label: '0.9Ã—' },
  { value: '1.0', label: '1.0Ã—' },
];

const isStandardCoefficient = (coef) => {
  return COEFFICIENT_OPTIONS.some(opt => parseFloat(opt.value) === coef);
};

const GroupEditor = ({ group, onUpdate, onRemove, canRemove }) => {
  const [customCoefEditing, setCustomCoefEditing] = useState({});

  const isIndividual = group.type === 'individual';

  const addMember = () => {
    if (isIndividual) return;
    onUpdate({
      ...group,
      members: [...group.members, { id: generateId(), name: '', isChild: false, coefficient: 1.0 }],
    });
  };

  const removeMember = (memberId) => {
    if (group.members.length <= 1) return;
    setCustomCoefEditing(prev => {
      const newState = { ...prev };
      delete newState[memberId];
      return newState;
    });
    onUpdate({
      ...group,
      members: group.members.filter(m => m.id !== memberId),
    });
  };

  const updateMember = (memberId, field, value) => {
    onUpdate({
      ...group,
      members: group.members.map(m => {
        if (m.id !== memberId) return m;
        if (field === 'isChild') {
          return { ...m, isChild: value };
        }
        if (field === 'coefficient') {
          const numVal = value === '' || value === 0 ? 0 : (parseFloat(value) || 0);
          return { ...m, coefficient: numVal };
        }
        return { ...m, [field]: value };
      }),
    });
  };

  const handleCoefficientChange = (memberId, value) => {
    if (value === 'custom') {
      setCustomCoefEditing(prev => ({ ...prev, [memberId]: true }));
    } else {
      setCustomCoefEditing(prev => ({ ...prev, [memberId]: false }));
      updateMember(memberId, 'coefficient', parseFloat(value));
    }
  };

  const getMemberCoefSelectValue = (member) => {
    if (customCoefEditing[member.id]) return 'custom';
    if (isStandardCoefficient(member.coefficient)) {
      return member.coefficient.toFixed(1);
    }
    return 'custom';
  };

  return (
    <div className={`bg-white rounded-lg shadow p-4 mb-4 ${isIndividual ? 'border-l-4 border-blue-400' : ''}`}>
      <div className="flex justify-between items-start mb-3">
        <div className="flex items-center gap-2 flex-1 mr-2">
          <span className="text-lg">{isIndividual ? 'ğŸ‘¤' : 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§'}</span>
          <input
            type="text"
            value={group.name}
            onChange={(e) => onUpdate({ ...group, name: e.target.value })}
            placeholder={isIndividual ? 'Meno' : 'NÃ¡zov skupiny'}
            className="text-lg font-semibold border-b border-gray-300 focus:border-blue-500 outline-none flex-1 pb-1"
          />
        </div>
        {canRemove && (
          <button onClick={onRemove} className="text-red-500 hover:text-red-700 text-sm">
            âœ• OdstrÃ¡niÅ¥
          </button>
        )}
      </div>

      <div className="mb-3">
        <label className="block text-sm text-gray-600 mb-1">PoÄet nocÃ­</label>
        <input
          type="number"
          min="1"
          value={group.nights === 0 ? '' : group.nights}
          onChange={(e) => onUpdate({ ...group, nights: e.target.value === '' ? 0 : (parseInt(e.target.value) || 0) })}
          onBlur={() => { if (!group.nights || group.nights < 1) onUpdate({ ...group, nights: 1 }); }}
          className="w-24 px-2 py-1 border rounded"
        />
      </div>

      <div className="space-y-2">
        {!isIndividual && <div className="text-sm text-gray-600 font-medium">ÄŒlenovia:</div>}
        {group.members.map((member, idx) => (
          <div key={member.id} className="flex flex-wrap items-center gap-2 bg-gray-50 p-2 rounded">
            {!isIndividual && <span className="text-gray-400 w-6">{idx + 1}.</span>}
            {!isIndividual && (
              <input
                type="text"
                value={member.name}
                onChange={(e) => updateMember(member.id, 'name', e.target.value)}
                placeholder="Meno"
                className="flex-1 min-w-20 px-2 py-1 border rounded text-sm"
              />
            )}
            <select
              value={member.isChild ? 'child' : 'adult'}
              onChange={(e) => updateMember(member.id, 'isChild', e.target.value === 'child')}
              className="px-2 py-1 border rounded text-sm bg-white"
            >
              <option value="adult">DospelÃ½</option>
              <option value="child">DieÅ¥a</option>
            </select>
            <select
              value={getMemberCoefSelectValue(member)}
              onChange={(e) => handleCoefficientChange(member.id, e.target.value)}
              className="w-20 px-1 py-1 border rounded text-sm bg-white"
            >
              {COEFFICIENT_OPTIONS.map(opt => (
                <option key={opt.value} value={opt.value}>{opt.label}</option>
              ))}
              <option value="custom">VlastnÃ©</option>
            </select>
            {(customCoefEditing[member.id] || !isStandardCoefficient(member.coefficient)) && (
              <input
                type="number"
                min="0"
                max="2"
                step="0.1"
                value={member.coefficient === 0 ? '' : member.coefficient}
                onChange={(e) => updateMember(member.id, 'coefficient', e.target.value === '' ? 0 : e.target.value)}
                className="w-16 px-1 py-1 border rounded text-sm text-center"
              />
            )}
            {group.members.length > 1 && (
              <button onClick={() => removeMember(member.id)} className="text-gray-400 hover:text-red-500">âœ•</button>
            )}
          </div>
        ))}
        {!isIndividual && (
          <button onClick={addMember} className="text-sm text-blue-600 hover:text-blue-800">
            + PridaÅ¥ Älena
          </button>
        )}
      </div>
    </div>
  );
};

const ExpenseEditor = ({ expense, families, onUpdate, onRemove }) => {
  const categories = [
    { value: 'accommodation', label: 'ğŸ  Ubytovanie' },
    { value: 'food', label: 'ğŸ½ï¸ Strava' },
    { value: 'other', label: 'ğŸ“¦ InÃ©' },
  ];

  return (
    <div className="flex flex-wrap items-center gap-2 bg-gray-50 p-3 rounded mb-2">
      <select
        value={expense.familyId}
        onChange={(e) => onUpdate({ ...expense, familyId: e.target.value })}
        className="px-2 py-1 border rounded text-sm"
      >
        <option value="">Kto zaplatil?</option>
        {families.map(f => (
          <option key={f.id} value={f.id}>
            {f.type === 'individual' ? 'ğŸ‘¤ ' : 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ '}
            {getGroupLabel(f)}
          </option>
        ))}
      </select>
      <select
        value={expense.category}
        onChange={(e) => onUpdate({ ...expense, category: e.target.value })}
        className="px-2 py-1 border rounded text-sm"
      >
        {categories.map(c => (
          <option key={c.value} value={c.value}>{c.label}</option>
        ))}
      </select>
      <input
        type="text"
        value={expense.description}
        onChange={(e) => onUpdate({ ...expense, description: e.target.value })}
        placeholder="Popis"
        className="flex-1 min-w-32 px-2 py-1 border rounded text-sm"
      />
      <div className="flex items-center gap-1">
        <input
          type="number"
          min="0"
          step="0.01"
          value={expense.amount === 0 ? '' : expense.amount}
          onChange={(e) => onUpdate({ ...expense, amount: e.target.value === '' ? 0 : (parseFloat(e.target.value) || 0) })}
          placeholder="0.00"
          className="w-24 px-2 py-1 border rounded text-sm text-right"
        />
        <span className="text-sm text-gray-500">â‚¬</span>
      </div>
      <button onClick={onRemove} className="text-gray-400 hover:text-red-500">âœ•</button>
    </div>
  );
};

const NotesEditor = ({ notes, onChange, readOnly = false }) => {
  if (readOnly) {
    if (!notes) return null;
    return (
      <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mt-4">
        <h4 className="font-semibold text-yellow-800 mb-2">ğŸ“ PoznÃ¡mka</h4>
        <p className="text-sm text-yellow-900 whitespace-pre-wrap">{notes}</p>
      </div>
    );
  }

  return (
    <div className="bg-white rounded-lg shadow p-4 mb-4">
      <h3 className="font-semibold text-gray-800 mb-2">ğŸ“ PoznÃ¡mka</h3>
      <textarea
        value={notes}
        onChange={(e) => onChange(e.target.value.slice(0, 600))}
        placeholder="PoznÃ¡mka pre ÃºÄastnÃ­kov..."
        className="w-full h-24 px-3 py-2 border rounded text-sm resize-none"
        maxLength={600}
      />
    </div>
  );
};

const ResultsPanel = ({ calculation, isReadOnly = false }) => {
  const results = calculateShares(calculation);
  const { settings } = results;
  const [expandedGroups, setExpandedGroups] = useState({});

  const toggleExpand = (familyId) => {
    setExpandedGroups(prev => ({ ...prev, [familyId]: !prev[familyId] }));
  };

  const getIcon = (type) => type === 'individual' ? 'ğŸ‘¤' : 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§';

  if (results.totalExpenses === 0) {
    return (
      <div className="bg-yellow-50 rounded-lg p-4 text-center text-yellow-700">
        Pridajte nÃ¡klady pre zobrazenie vÃ½sledkov
      </div>
    );
  }

  return (
    <div className="space-y-4">
      <div className="bg-blue-50 rounded-lg p-4">
        <h3 className="font-semibold text-blue-900 mb-2">ğŸ“Š CelkovÃ© nÃ¡klady</h3>
        <div className="grid grid-cols-2 gap-2 text-sm">
          <div>Ubytovanie:</div>
          <div className="text-right font-medium">{results.expensesByCategory.accommodation.toFixed(2)} â‚¬</div>
          <div>Strava:</div>
          <div className="text-right font-medium">{results.expensesByCategory.food.toFixed(2)} â‚¬</div>
          <div>InÃ©:</div>
          <div className="text-right font-medium">{results.expensesByCategory.other.toFixed(2)} â‚¬</div>
          <div className="font-bold border-t pt-1">Spolu:</div>
          <div className="text-right font-bold border-t pt-1">{results.totalExpenses.toFixed(2)} â‚¬</div>
        </div>
      </div>

      <div className="bg-gray-50 rounded-lg p-4">
        <h3 className="font-semibold text-gray-900 mb-2">ğŸ‘¥ Podiely</h3>
        <div className="space-y-3">
          {results.shouldPayByFamily.map((family) => (
            <div key={family.familyId} className="bg-white p-3 rounded shadow-sm">
              <div className="font-medium mb-1">{getIcon(family.familyType)} {family.familyName}</div>
              <div className="text-xs text-gray-500 mb-2">
                {family.memberCount} os. Ã— {family.nights} nocÃ­ â€¢ VÃ¡ha: {family.weightedUnits.toFixed(1)}
              </div>
              <div className="grid grid-cols-2 gap-1 text-sm">
                <div>Ubytovanie:</div><div className="text-right">{family.accommodation.toFixed(2)} â‚¬</div>
                <div>Strava:</div><div className="text-right">{family.food.toFixed(2)} â‚¬</div>
                <div>InÃ©:</div><div className="text-right">{family.other.toFixed(2)} â‚¬</div>
                <div className="font-semibold border-t pt-1">MÃ¡ zaplatiÅ¥:</div>
                <div className="text-right font-semibold border-t pt-1">{family.total.toFixed(2)} â‚¬</div>
              </div>
            </div>
          ))}
        </div>
      </div>

      <div className="bg-gray-50 rounded-lg p-4">
        <h3 className="font-semibold text-gray-900 mb-2">ğŸ’° Bilancia</h3>
        <div className="space-y-2">
          {results.balances.map((balance) => (
            <div key={balance.familyId} className="flex justify-between items-center bg-white p-2 rounded">
              <span>{getIcon(balance.familyType)} {balance.familyName}</span>
              <div className="text-right text-sm">
                <div className="text-gray-500">Zaplatil: {balance.paid.toFixed(2)} â‚¬</div>
                <div className={`font-medium ${balance.balance > 0.01 ? 'text-green-600' : balance.balance < -0.01 ? 'text-red-600' : 'text-gray-600'}`}>
                  {balance.balance > 0.01 ? `+${balance.balance.toFixed(2)} â‚¬` : balance.balance < -0.01 ? `${balance.balance.toFixed(2)} â‚¬` : 'VyrovnanÃ©'}
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>

      {results.settlements.length > 0 && (
        <div className="bg-green-50 rounded-lg p-4">
          <h3 className="font-semibold text-green-900 mb-2">âœ… Vyrovnanie</h3>
          <div className="space-y-2">
            {results.settlements.map((settlement, idx) => (
              <div key={idx} className="flex items-center justify-between bg-white p-3 rounded shadow-sm">
                <span className="font-medium">{settlement.from}</span>
                <span className="text-gray-400 mx-2">â†’</span>
                <span className="font-medium">{settlement.to}</span>
                <span className="font-bold text-green-700 ml-4">{settlement.amount.toFixed(2)} â‚¬</span>
              </div>
            ))}
          </div>
        </div>
      )}

      {isReadOnly && <NotesEditor notes={calculation.notes} readOnly={true} />}
    </div>
  );
};

const CalculationView = ({ calculation, onUpdate, onBack, onSave, isReadOnly = false, user }) => {
  const [activeTab, setActiveTab] = useState(isReadOnly ? 'results' : 'families');
  const [saving, setSaving] = useState(false);
  const [shareUrl, setShareUrl] = useState('');
  const [copied, setCopied] = useState(false);

  const MAX_GROUPS = 15;

  const updateGroup = (updatedGroup) => {
    onUpdate({ ...calculation, families: calculation.families.map(f => f.id === updatedGroup.id ? updatedGroup : f) });
  };

  const removeGroup = (groupId) => {
    if (calculation.families.length <= 2) return;
    onUpdate({
      ...calculation,
      families: calculation.families.filter(f => f.id !== groupId),
      expenses: calculation.expenses.filter(e => e.familyId !== groupId),
    });
  };

  const addGroup = (type = 'group') => {
    if (calculation.families.length >= MAX_GROUPS) return;
    onUpdate({ ...calculation, families: [...calculation.families, defaultGroup(type)] });
  };

  const updateExpense = (updatedExpense) => {
    onUpdate({ ...calculation, expenses: calculation.expenses.map(e => e.id === updatedExpense.id ? updatedExpense : e) });
  };

  const removeExpense = (expenseId) => {
    onUpdate({ ...calculation, expenses: calculation.expenses.filter(e => e.id !== expenseId) });
  };

  const addExpense = () => {
    const newExpense = defaultExpense();
    if (calculation.families.length > 0) newExpense.familyId = calculation.families[0].id;
    onUpdate({ ...calculation, expenses: [...calculation.expenses, newExpense] });
  };

  const handleSave = async () => {
    if (!user) {
      alert('Pre uloÅ¾enie prepoÄtu sa prosÃ­m prihlÃ¡ste.');
      return;
    }

    setSaving(true);
    const shortId = await onSave(calculation);
    if (shortId) {
      const url = `${window.location.origin}${window.location.pathname}?s=${shortId}`;
      setShareUrl(url);
    }
    setSaving(false);
  };

  const copyShareUrl = () => {
    navigator.clipboard.writeText(shareUrl);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  const settings = calculation.settings || defaultSettings();

  return (
    <div className="min-h-screen bg-gray-100">
      <div className="bg-white shadow-sm sticky top-0 z-10">
        <div className="max-w-2xl mx-auto px-4 py-3">
          <div className="flex items-center gap-3 mb-2">
            <button onClick={onBack} className="text-gray-500 hover:text-gray-700">â† SpÃ¤Å¥</button>
            {isReadOnly ? (
              <h1 className="text-xl font-bold flex-1">{calculation.name}</h1>
            ) : (
              <input
                type="text"
                value={calculation.name}
                onChange={(e) => onUpdate({ ...calculation, name: e.target.value })}
                className="text-xl font-bold flex-1 border-b border-transparent hover:border-gray-300 focus:border-blue-500 outline-none"
                placeholder="NÃ¡zov dovolenky"
              />
            )}
          </div>

          {!isReadOnly && (
            <div className="flex gap-2 flex-wrap">
              <button
                onClick={handleSave}
                disabled={saving || !user}
                className={`px-4 py-1 rounded text-sm ${user ? 'bg-blue-600 text-white hover:bg-blue-700' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}
              >
                {saving ? 'UkladÃ¡m...' : 'ğŸ’¾ UloÅ¾iÅ¥ a zdieÄ¾aÅ¥'}
              </button>
              {!user && (
                <span className="text-xs text-gray-500 self-center">PrihlÃ¡ste sa pre uloÅ¾enie</span>
              )}
              {shareUrl && (
                <button
                  onClick={copyShareUrl}
                  className={`px-4 py-1 rounded text-sm ${copied ? 'bg-green-600 text-white' : 'bg-green-100 text-green-700 hover:bg-green-200'}`}
                >
                  {copied ? 'âœ“ SkopÃ­rovanÃ©!' : 'ğŸ“‹ KopÃ­rovaÅ¥ link'}
                </button>
              )}
            </div>
          )}

          {shareUrl && !isReadOnly && (
            <div className="mt-2 p-2 bg-green-50 rounded text-xs text-green-700">
              <div className="font-medium mb-1">âœ… Link vytvorenÃ½!</div>
              <div className="break-all bg-white p-1 rounded border border-green-200">{shareUrl}</div>
            </div>
          )}

          {isReadOnly && (
            <div className="mt-2 p-2 bg-blue-50 rounded text-xs text-blue-700">
              ğŸ“– ZdieÄ¾anÃ½ prepoÄet (len na ÄÃ­tanie)
            </div>
          )}
        </div>

        <div className="max-w-2xl mx-auto px-4 flex border-t">
          {(isReadOnly ? ['results'] : ['families', 'expenses', 'results']).map(tab => (
            <button
              key={tab}
              onClick={() => setActiveTab(tab)}
              className={`flex-1 py-2 text-center text-sm font-medium border-b-2 ${
                activeTab === tab ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500'
              }`}
            >
              {tab === 'families' && 'ğŸ‘¥ ÃšÄastnÃ­ci'}
              {tab === 'expenses' && 'ğŸ’³ NÃ¡klady'}
              {tab === 'results' && 'ğŸ“Š VÃ½sledky'}
            </button>
          ))}
        </div>
      </div>

      <div className="max-w-2xl mx-auto px-4 py-4">
        {activeTab === 'families' && !isReadOnly && (
          <div>
            <SettingsPanel settings={settings} onUpdate={(s) => onUpdate({ ...calculation, settings: s })} />
            {calculation.families.map((group) => (
              <GroupEditor
                key={group.id}
                group={group}
                onUpdate={updateGroup}
                onRemove={() => removeGroup(group.id)}
                canRemove={calculation.families.length > 2}
              />
            ))}
            {calculation.families.length < MAX_GROUPS && (
              <div className="flex gap-2">
                <button onClick={() => addGroup('group')} className="flex-1 py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-blue-400 hover:text-blue-600">
                  ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ + Skupina
                </button>
                <button onClick={() => addGroup('individual')} className="flex-1 py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-blue-400 hover:text-blue-600">
                  ğŸ‘¤ + Jednotlivec
                </button>
              </div>
            )}
          </div>
        )}

        {activeTab === 'expenses' && !isReadOnly && (
          <div>
            <NotesEditor notes={calculation.notes || ''} onChange={(notes) => onUpdate({ ...calculation, notes })} />
            {calculation.expenses.length === 0 ? (
              <div className="text-center py-8 text-gray-500">ZatiaÄ¾ Å¾iadne nÃ¡klady.</div>
            ) : (
              calculation.expenses.map(expense => (
                <ExpenseEditor
                  key={expense.id}
                  expense={expense}
                  families={calculation.families}
                  onUpdate={updateExpense}
                  onRemove={() => removeExpense(expense.id)}
                />
              ))
            )}
            <button onClick={addExpense} className="w-full py-3 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 hover:border-blue-400 hover:text-blue-600 mt-2">
              + PridaÅ¥ nÃ¡klad
            </button>
          </div>
        )}

        {activeTab === 'results' && <ResultsPanel calculation={calculation} isReadOnly={isReadOnly} />}
      </div>
    </div>
  );
};

const UserHeader = ({ user, onLogout }) => {
  if (!user) return null;

  return (
    <div className="flex items-center gap-3 bg-white px-4 py-2 border-b">
      <img src={user.picture} alt="" className="w-8 h-8 rounded-full" />
      <span className="text-sm text-gray-700 flex-1">{user.name}</span>
      <button onClick={onLogout} className="text-sm text-gray-500 hover:text-gray-700">
        OdhlÃ¡siÅ¥
      </button>
    </div>
  );
};

const LoginPrompt = ({ onLogin, loading }) => {
  const googleButtonRef = useRef(null);

  useEffect(() => {
    if (typeof google !== 'undefined' && google.accounts && googleButtonRef.current) {
      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: onLogin
      });
      google.accounts.id.renderButton(googleButtonRef.current, {
        theme: 'outline',
        size: 'large',
        text: 'continue_with',
        width: 280
      });
    }
  }, [onLogin]);

  return (
    <div className="bg-white rounded-lg shadow p-6 mb-6">
      <h3 className="font-semibold text-gray-800 mb-2">ğŸ” PrihlÃ¡ste sa</h3>
      <p className="text-sm text-gray-600 mb-4">
        Pre ukladanie a synchronizÃ¡ciu prepoÄtov medzi zariadeniami sa prihlÃ¡ste cez Google.
      </p>
      {loading ? (
        <div className="text-center py-4 text-gray-500">Prihlasujem...</div>
      ) : (
        <div ref={googleButtonRef} className="flex justify-center"></div>
      )}
    </div>
  );
};

const HomeView = ({ calculations, onSelect, onCreate, onDelete, loading, user, onLogin, onLogout, authLoading }) => {
  return (
    <div className="min-h-screen bg-gray-100">
      {user && <UserHeader user={user} onLogout={onLogout} />}

      <div className="bg-gradient-to-br from-blue-600 to-blue-800 text-white py-8 px-4">
        <div className="max-w-2xl mx-auto">
          <h1 className="text-2xl font-bold mb-2">ğŸ”ï¸ Splitwise</h1>
          <p className="text-blue-100">SpravodlivÃ© rozdelenie nÃ¡kladov z dovolenky</p>
        </div>
      </div>

      <div className="max-w-2xl mx-auto px-4 py-6">
        {!user && <LoginPrompt onLogin={onLogin} loading={authLoading} />}

        <button
          onClick={onCreate}
          className="w-full py-4 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 shadow-lg mb-6"
        >
          + NovÃ½ prepoÄet
        </button>

        {loading ? (
          <div className="text-center py-8 text-gray-500">NaÄÃ­tavam...</div>
        ) : user && calculations.length > 0 ? (
          <div>
            <h2 className="text-lg font-semibold text-gray-700 mb-3">VaÅ¡e prepoÄty</h2>
            <div className="space-y-2">
              {calculations.map(calc => (
                <div key={calc.id} className="bg-white rounded-lg shadow p-4 flex justify-between items-center">
                  <div className="flex-1 cursor-pointer" onClick={() => onSelect(calc)}>
                    <div className="font-medium">{calc.name}</div>
                    <div className="text-sm text-gray-500">
                      {calc.families?.length || 0} ÃºÄastnÃ­kov â€¢ {calc.expenses?.length || 0} nÃ¡kladov
                    </div>
                    <div className="text-xs text-gray-400">
                      {new Date(calc.createdAt).toLocaleDateString('sk-SK')}
                    </div>
                  </div>
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      if (confirm('Naozaj chcete vymazaÅ¥ tento prepoÄet?')) onDelete(calc.id);
                    }}
                    className="text-gray-400 hover:text-red-500 ml-4"
                  >
                    ğŸ—‘ï¸
                  </button>
                </div>
              ))}
            </div>
          </div>
        ) : user ? (
          <div className="text-center py-8 text-gray-500">ZatiaÄ¾ Å¾iadne uloÅ¾enÃ© prepoÄty</div>
        ) : (
          <div className="text-center py-8 text-gray-500">
            PrihlÃ¡ste sa pre zobrazenie uloÅ¾enÃ½ch prepoÄtov
          </div>
        )}

        <div className="mt-8 p-4 bg-white rounded-lg shadow">
          <h3 className="font-semibold mb-2">â„¹ï¸ Ako to funguje?</h3>
          <ul className="text-sm text-gray-600 space-y-1">
            <li>1. Vytvorte novÃ½ prepoÄet</li>
            <li>2. Pridajte ÃºÄastnÃ­kov a nÃ¡klady</li>
            <li>3. Pozrite si kto komu koÄ¾ko dlhuje</li>
            <li>4. ZdieÄ¾ajte link s ostatnÃ½mi</li>
          </ul>
        </div>
      </div>
    </div>
  );
};

// Main App
function SplitWiseApp() {
  const [view, setView] = useState('home');
  const [calculations, setCalculations] = useState([]);
  const [currentCalc, setCurrentCalc] = useState(null);
  const [loading, setLoading] = useState(true);
  const [isReadOnly, setIsReadOnly] = useState(false);
  const [user, setUser] = useState(null);
  const [authLoading, setAuthLoading] = useState(false);

  // Check for existing auth token on load
  useEffect(() => {
    const checkAuth = async () => {
      const token = getAuthToken();
      if (token) {
        try {
          const response = await apiRequest('/api/auth/me');
          if (response.ok) {
            const userData = await response.json();
            setUser(userData);
          } else {
            clearAuthToken();
          }
        } catch (e) {
          clearAuthToken();
        }
      }
    };
    checkAuth();
  }, []);

  // Load data on init
  useEffect(() => {
    const init = async () => {
      const urlParams = new URLSearchParams(window.location.search);

      // Check for short URL parameter
      const shortId = urlParams.get('s');
      if (shortId) {
        const data = await loadFromApi(shortId);
        if (data) {
          setCurrentCalc({
            ...data,
            settings: data.settings || defaultSettings(),
            notes: data.notes || '',
            families: (data.families || []).map(f => ({
              ...f,
              type: f.type || 'group',
              members: (f.members || []).map(m => ({
                ...m,
                coefficient: m.coefficient !== undefined ? m.coefficient : 1.0,
                isChild: m.isChild !== undefined ? m.isChild : false,
              })),
            })),
          });
          setIsReadOnly(true);
          setView('calculation');
          setLoading(false);
          return;
        }
      }

      // Check for legacy base64 data
      const encodedData = urlParams.get('data');
      if (encodedData) {
        const decoded = decodeCalcData(encodedData);
        if (decoded) {
          setCurrentCalc({
            ...decoded,
            settings: decoded.settings || defaultSettings(),
            notes: decoded.notes || '',
            families: (decoded.families || []).map(f => ({
              ...f,
              type: f.type || 'group',
              members: (f.members || []).map(m => ({
                ...m,
                coefficient: m.coefficient !== undefined ? m.coefficient : 1.0,
                isChild: m.isChild !== undefined ? m.isChild : false,
              })),
            })),
          });
          setIsReadOnly(true);
          setView('calculation');
          setLoading(false);
          return;
        }
      }

      // Load user's calculations if logged in
      if (getAuthToken()) {
        const calcs = await loadUserCalculations();
        setCalculations(calcs);
      }
      setLoading(false);
    };

    init();
  }, [user]);

  const handleGoogleLogin = async (credentialResponse) => {
    setAuthLoading(true);
    try {
      const response = await fetch(`${API_URL}/api/auth/google`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token: credentialResponse.credential })
      });

      if (response.ok) {
        const { token, user: userData } = await response.json();
        setAuthToken(token);
        setUser(userData);

        // Load user's calculations
        const calcs = await loadUserCalculations();
        setCalculations(calcs);
      } else {
        alert('PrihlÃ¡senie zlyhalo. SkÃºste to znova.');
      }
    } catch (e) {
      console.error('Login error:', e);
      alert('PrihlÃ¡senie zlyhalo. SkÃºste to znova.');
    }
    setAuthLoading(false);
  };

  const handleLogout = () => {
    clearAuthToken();
    setUser(null);
    setCalculations([]);
  };

  const handleCreate = () => {
    setCurrentCalc(defaultCalculation());
    setIsReadOnly(false);
    setView('calculation');
  };

  const handleSelect = (calc) => {
    setCurrentCalc({
      ...calc,
      settings: calc.settings || defaultSettings(),
      notes: calc.notes || '',
      families: (calc.families || []).map(f => ({
        ...f,
        type: f.type || 'group',
        members: (f.members || []).map(m => ({
          ...m,
          coefficient: m.coefficient !== undefined ? m.coefficient : 1.0,
          isChild: m.isChild !== undefined ? m.isChild : false,
        })),
      })),
    });
    setIsReadOnly(false);
    setView('calculation');
  };

  const handleDelete = async (id) => {
    const success = await deleteCalculation(id);
    if (success) {
      setCalculations(calculations.filter(c => c.id !== id));
    }
  };

  const handleSave = async (calculation) => {
    const shortId = await saveToApi(calculation);
    if (shortId) {
      // Refresh calculations list
      const calcs = await loadUserCalculations();
      setCalculations(calcs);
    }
    return shortId;
  };

  const handleBack = () => {
    setView('home');
    setCurrentCalc(null);
    setIsReadOnly(false);
    window.history.replaceState({}, '', window.location.pathname);
  };

  if (view === 'calculation' && currentCalc) {
    return (
      <CalculationView
        calculation={currentCalc}
        onUpdate={setCurrentCalc}
        onBack={handleBack}
        onSave={handleSave}
        isReadOnly={isReadOnly}
        user={user}
      />
    );
  }

  return (
    <HomeView
      calculations={calculations}
      onSelect={handleSelect}
      onCreate={handleCreate}
      onDelete={handleDelete}
      loading={loading}
      user={user}
      onLogin={handleGoogleLogin}
      onLogout={handleLogout}
      authLoading={authLoading}
    />
  );
}

ReactDOM.render(<SplitWiseApp />, document.getElementById('root'));
    </script>
</body>
</html>
